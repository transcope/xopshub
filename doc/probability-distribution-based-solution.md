# 基于概率的方法
这里主要收集以统计分析为主用于解决的运维场景和问题。


## 二项分布如何用于网络判障

* 场景

探测内网连通性（机房到机房），以服务器 $a$ 去探测服务器 $b$ 为例，每次探测有两种结果（成功，失败），假设发出 $n$ 个数据包，其中 $m$ 个成功， $n-m$ 个失败。 

* 问题

理论上，网络状态正常， $m/n=100$% ，但实际上由于各种不确定性因素（服务器负载高、服务器重启，等），少量的数据包失败是可接受的。因此，需要设定一个判障阈值。

* 需求

人工设置阈值不合理，因为服务器之间连接情况不同，系统复杂且动态运行。判障算法要求是通用的、低开销的、高鲁棒性的。不能针对具体任务训练阈值，这样维护成本很大。

* 难点
	* 难点一：数据噪声。如服务器负载高、机器重启等，这些事件不能说明网络存在问题。
	* 难点二：不同任务的采样数量差距大。由于网络结构不同，以及数据噪声，小样本的探测任务难以准确判障。

* 方案

	* 将网络连接探测看作为伯努利试验。假设收发的数据包为相互独立的样本（成功 or 失败），服从二项分布 $B(n，p)$ ，其中 $n$ 表示数据包个数， $p$ 表示网络正常状态下探测的成功概率。
求 $P(x<=m)$ 的值，即探测失败的概率。

	* 根据中心极限定理，二项分布近似服从正态分布，因此可通过计算 $Z-Score$ 值代替 $P(x<=m)$ 。 
		
		* 计算 $Z-Score$ ：
			
			$$
			\begin{aligned}
			Z= \frac{X-\mu}{\sigma}
			&= \frac{X-np}{\sqrt{np\left(1-p\right)}} 
			\end{aligned}
			$$
			
		* 网络正常状态下探测的成功概率 $p$ ，可通过人工设置阈值，或者极大似然估计。     
		* 设定初始阈值  $z_0$ ，当 $Z$ 值小于 $z_0$ 时，进行故障检测。

<p align="center">
  <img src="../image/baidu_z-score.jpeg" width="600"/>
</p>

* 补充说明
	* 难点二的用例。假设任务 $a$ 发送100个样本，成功收到60个样本，任务 $b$ 发送10个样本，成功收到6个样本，表面上 $m/n=60$%，网络探测成功率相同。通过计算 $Z-Score$ 可得 $z_a=-5$ ， $z_b=-1.12$ ，两者具有明显差异。
	* 针对业务和应用的周期变化不同，可以按时间进行划分，分别计算阈值。比如，中午比晚上交易量大，计算负载高，网络链接阈值可以设置不同。比如，每台服务器设置24个阈值，重大节日采用特定阈值。


* 参考资料：[二项分布为何能在网络判障中发挥大作用？](https://mp.weixin.qq.com/s?src=11&timestamp=1659960263&ver=3970&signature=ZB4JYkGEIRdseUjXmjdh77z9oCuxWCfi12PbpJi1rWzPWt9gi2eNxHqpO7THdxIlxColdEDnvVb8V81htH2w-mCOJOQXa8PsXGGPlfZzU5eN4QrKnqIO5T1AuR7jzmL7&new=1)	

## 柏松分布如何做流量异常检测

* 场景

流量能够反映系统的运行状态。流量通常平稳波动，当流量出现异常突升或突降，说明系统可能出现故障。例如，网络故障导致系统无法接收访问请求，从而导致流量突降。

* 流量异常检测，包括如下两个阶段
	* 阶段一：预测。
		* 如何对流量进行精准预测。
		* 这里主要挑战是，导致流量突变的因素多变，如业务调整、外部攻击、系统故障，等。
		* 算法需要适应变化，进一步能够区分各种情况。

	*  阶段二：预警。
		* 如何对异常进行正确报警。
		* 这里主要挑战是，流量波动存在较大差异。比如，白天流量大，预测相差10%是异常，夜间流量小，相差20%都是正常的。导致无法采用残差与相对残差等方法建立统一阈值。
		* 算法需要提供一套在不同情况下界定异常的方法。

* 流量预测

文献中采用鲁棒回归算法。更合理的做法是集合学习：采用一揽子预测模型，以及自适应调优。其假设是，导致流量变化的因素在发生变化，不同模型适用的情况不同，通过动态调整模型权重进行判断。

关于这部分的问题和解决方案，将在时间序列模式中进行详细阐述。

* 基于泊松分布的预警（异常检测）

	* 泊松分布适用于流量建模。流量是指系统一段时间内接受到请求的次数，而泊松分布是描述单位时间内随机事件发生的次数。

	* 假设一段时间 $t$ 的用户请求数（流量），真实值为  $y_t$，预测值为 $\hat{y_t}$ ，计算两者之间的差异，
		* 泊松分布：

		  $$ \begin{aligned}  P(k=y_{t}; \lambda=\hat{y_{t}})=\frac{\lambda ^{k}}{k!}{e ^{-\lambda}}=\frac{\hat{y_{t}} ^{y_{t}}}{y_{t}!}{e ^{-\hat{y_{t}}}} \end{aligned} $$
		
		* 由于计算开销大，这里同样采用正态分布近似泊松分布， 计算 $Z$ 值：

		  $$ \begin{aligned} z=\frac{y_{t}-\hat{y_{t}}}{\sqrt{\hat{y_{t}}}} \end{aligned} $$

		* 关于如何界定异常（建立统一检测阈值）
	

* 参考资料：[我们不一样！告诉你百度是如何做智能流量异常检测的](https://cloud.tencent.com/developer/news/291894) 


## 如何监测响应时间（正态分布，高斯核密度估计）

* 场景

响应时间是指系统处理请求的时间。这类指标能够反应应用和系统问题。首先，用户可能因为等待时间长转而使用更快的竞品。其次，造成响应慢有多种原因，如网络延迟、IO等待、进程阻塞。

* 正态分布



* 高斯核密度估计



* 前处理

这部分需要通过实操总结经验。比如，数据聚类剔除极端异常值。

* 参考资料：百度异常检测实践